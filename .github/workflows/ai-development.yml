name: AI Driven Development

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Development mode'
        required: true
        default: 'full'
        type: choice
        options:
        - full          # å…¨è‡ªå‹•å®Ÿè¡Œ
        - issues-only   # Issueç”Ÿæˆã®ã¿
        - implement     # å®Ÿè£…ã®ã¿
        - review        # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿
      max_parallel:
        description: 'Maximum parallel sessions'
        required: false
        default: '3'
        type: string
      feature_filter:
        description: 'Feature filter (optional)'
        required: false
        type: string

env:
  CLAUDE_CODE_API_KEY: ${{ secrets.CLAUDE_CODE_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  MAX_PARALLEL: ${{ github.event.inputs.max_parallel || '3' }}
  DEVELOPMENT_MODE: ${{ github.event.inputs.mode }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      should-generate-issues: ${{ steps.mode-check.outputs.generate-issues }}
      should-implement: ${{ steps.mode-check.outputs.implement }}
      should-review: ${{ steps.mode-check.outputs.review }}
    steps:
      - name: Check development mode
        id: mode-check
        run: |
          MODE="${{ github.event.inputs.mode }}"
          
          case $MODE in
            "full")
              echo "generate-issues=true" >> $GITHUB_OUTPUT
              echo "implement=true" >> $GITHUB_OUTPUT
              echo "review=true" >> $GITHUB_OUTPUT
              ;;
            "issues-only")
              echo "generate-issues=true" >> $GITHUB_OUTPUT
              echo "implement=false" >> $GITHUB_OUTPUT
              echo "review=false" >> $GITHUB_OUTPUT
              ;;
            "implement")
              echo "generate-issues=false" >> $GITHUB_OUTPUT
              echo "implement=true" >> $GITHUB_OUTPUT
              echo "review=false" >> $GITHUB_OUTPUT
              ;;
            "review")
              echo "generate-issues=false" >> $GITHUB_OUTPUT
              echo "implement=false" >> $GITHUB_OUTPUT
              echo "review=true" >> $GITHUB_OUTPUT
              ;;
          esac
          
      - name: Notify start
        run: |
          echo "ðŸš€ AIé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™"
          echo "ãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.mode }}"
          echo "ä¸¦è¡Œæ•°: ${{ env.MAX_PARALLEL }}"

  analyze-requirements:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-generate-issues == 'true'
    outputs:
      issues-matrix: ${{ steps.analysis.outputs.issues-matrix }}
      total-issues: ${{ steps.analysis.outputs.total-issues }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Analyze requirements
        id: analysis
        run: |
          echo "ðŸ“‹ è¦ä»¶ã‚’è§£æžä¸­..."
          
          # Node.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¦ä»¶è§£æžã‚’å®Ÿè¡Œ
          cat > analyze.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          async function analyzeRequirements() {
            try {
              // CLAUDE.mdã¨è¦ä»¶å®šç¾©æ›¸ã‚’èª­ã¿è¾¼ã¿
              const claudemd = fs.readFileSync('CLAUDE.md', 'utf-8');
              const requirements = fs.readFileSync('docs/requirements.md', 'utf-8');
              
              // æœªå®Ÿè£…æ©Ÿèƒ½ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
              const unimplementedFeatures = [
                {
                  title: "ãƒ¬ã‚·ãƒ”ææ¡ˆAIæ©Ÿèƒ½ã®å®Ÿè£…",
                  description: "OpenAI APIã‚’ä½¿ç”¨ã—ã¦ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆã™ã‚‹æ©Ÿèƒ½",
                  priority: "high",
                  estimate: "3d",
                  files: ["app/api/recipes/route.ts", "lib/openai.ts"],
                  dependencies: []
                },
                {
                  title: "èª¿å‘³æ–™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã®å®Ÿè£…",
                  description: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã£ã¦ã„ã‚‹èª¿å‘³æ–™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ©Ÿèƒ½",
                  priority: "high", 
                  estimate: "2d",
                  files: ["components/features/seasoning-check.tsx", "stores/seasoning.ts"],
                  dependencies: []
                },
                {
                  title: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨å®Ÿè£…",
                  description: "Prisma + Supabaseã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ",
                  priority: "high",
                  estimate: "4d", 
                  files: ["prisma/schema.prisma", "lib/database.ts"],
                  dependencies: []
                },
                {
                  title: "èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…",
                  description: "NextAuth.js + Supabaseã§ã®èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ",
                  priority: "medium",
                  estimate: "3d",
                  files: ["app/api/auth/[...nextauth]/route.ts", "lib/auth.ts"],
                  dependencies: []
                },
                {
                  title: "ä»£æ›¿ãƒ¬ã‚·ãƒ”ææ¡ˆæ©Ÿèƒ½",
                  description: "èª¿å‘³æ–™ä¸è¶³æ™‚ã®ä»£æ›¿ãƒ¬ã‚·ãƒ”ææ¡ˆã‚·ã‚¹ãƒ†ãƒ ",
                  priority: "medium",
                  estimate: "2d",
                  files: ["lib/recipe-alternatives.ts", "components/features/alternative-recipes.tsx"],
                  dependencies: ["ãƒ¬ã‚·ãƒ”ææ¡ˆAIæ©Ÿèƒ½ã®å®Ÿè£…", "èª¿å‘³æ–™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã®å®Ÿè£…"]
                }
              ];
              
              console.log(`Found ${unimplementedFeatures.length} unimplemented features`);
              
              return {
                issues: unimplementedFeatures,
                total: unimplementedFeatures.length
              };
            } catch (error) {
              console.error('Analysis failed:', error);
              return { issues: [], total: 0 };
            }
          }
          
          analyzeRequirements().then(result => {
            console.log('issues-matrix=' + JSON.stringify(result.issues));
            console.log('total-issues=' + result.total);
          });
          EOF
          
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã—ã¦çµæžœã‚’å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          node analyze.js > analysis_output.txt
          
          # å‡ºåŠ›å¤‰æ•°ã‚’è¨­å®š
          ISSUES_MATRIX=$(grep "issues-matrix=" analysis_output.txt | cut -d'=' -f2-)
          TOTAL_ISSUES=$(grep "total-issues=" analysis_output.txt | cut -d'=' -f2-)
          
          echo "issues-matrix=${ISSUES_MATRIX}" >> $GITHUB_OUTPUT
          echo "total-issues=${TOTAL_ISSUES}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š è§£æžå®Œäº†: ${TOTAL_ISSUES}å€‹ã®æœªå®Ÿè£…æ©Ÿèƒ½ã‚’ç™ºè¦‹"

  generate-issues:
    runs-on: ubuntu-latest
    needs: [setup, analyze-requirements]
    if: needs.setup.outputs.should-generate-issues == 'true'
    strategy:
      max-parallel: 5
      matrix:
        feature: ${{ fromJson(needs.analyze-requirements.outputs.issues-matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Generate issue for feature
        run: |
          echo "ðŸŽ« Issueç”Ÿæˆä¸­: ${{ matrix.feature.title }}"
          
          # Issueæœ¬æ–‡ã‚’ç”Ÿæˆ
          cat > issue_body.md << EOF
          ## ðŸ“‹ æ©Ÿèƒ½æ¦‚è¦
          ${{ matrix.feature.description }}
          
          ## ðŸŽ¯ å®Ÿè£…ç›®æ¨™
          - [ ] ${{ matrix.feature.title }}ã®åŸºæœ¬å®Ÿè£…
          - [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ä½œæˆ
          - [ ] çµ±åˆãƒ†ã‚¹ãƒˆã®ä½œæˆ
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
          
          ## ðŸ“ å®Ÿè£…è©³ç´°
          ### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
          $(echo '${{ toJson(matrix.feature.files) }}' | jq -r '.[] | "- `" + . + "`"')
          
          ### æŠ€è¡“è¦ä»¶
          - TypeScript strict ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
          - CLAUDE.md è¦ç´„æº–æ‹ 
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
          - ãƒ­ã‚°å‡ºåŠ›å¯¾å¿œ
          
          ## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶
          - [ ] æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
          - [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š
          - [ ] CLAUDE.mdè¦ç´„ã«æº–æ‹ ã—ã¦ã„ã‚‹
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡
          - [ ] TypeScriptåž‹å®šç¾©ãŒæ­£ç¢º
          
          ## ðŸ§ª ãƒ†ã‚¹ãƒˆè¦ä»¶
          - [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®å®Ÿè£…
          - [ ] çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè£…
          - [ ] ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ
          - [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ
          
          ## ðŸ·ï¸ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
          - **å„ªå…ˆåº¦**: ${{ matrix.feature.priority }}
          - **è¦‹ç©ã‚‚ã‚Š**: ${{ matrix.feature.estimate }}
          - **ä¾å­˜é–¢ä¿‚**: $(echo '${{ toJson(matrix.feature.dependencies) }}' | jq -r 'join(", ") // "ãªã—"')
          
          ---
          *ðŸ¤– ã“ã®Issueã¯AIé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          
          **è‡ªå‹•å®Ÿè£…ã‚’é–‹å§‹ã™ã‚‹ã«ã¯:**
          \`\`\`
          gh workflow run ai-development.yml -f mode=implement -f feature="${{ matrix.feature.title }}"
          \`\`\`
          EOF
          
          # Issueã‚’ä½œæˆ
          ISSUE_URL=$(gh issue create \
            --title "${{ matrix.feature.title }}" \
            --body-file issue_body.md \
            --label "ai-generated,enhancement,${{ matrix.feature.priority }}-priority" \
            --assignee "@me")
            
          echo "âœ… Issueä½œæˆå®Œäº†: $ISSUE_URL"
          
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  parallel-implementation:
    runs-on: ubuntu-latest
    needs: [setup, generate-issues]
    if: needs.setup.outputs.should-implement == 'true'
    strategy:
      max-parallel: ${{ fromJson(github.event.inputs.max_parallel || '3') }}
      matrix:
        feature: ${{ fromJson(needs.analyze-requirements.outputs.issues-matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup development environment
        run: |
          echo "ðŸ”§ é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
          git config --global user.name "AI Developer"
          git config --global user.email "ai-developer@example.com"
          
      - name: Create feature branch
        run: |
          BRANCH_NAME="feature/ai-$(echo '${{ matrix.feature.title }}' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')"
          echo "ðŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒä½œæˆ: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
      - name: Implement feature (Mock)
        run: |
          echo "âš™ï¸ æ©Ÿèƒ½å®Ÿè£…ä¸­: ${{ matrix.feature.title }}"
          echo "ðŸ“ å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $(echo '${{ toJson(matrix.feature.files) }}' | jq -r 'join(", ")')"
          
          # Mockå®Ÿè£…ï¼ˆå®Ÿéš›ã®Claude Code APIå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆäºˆå®šï¼‰
          mkdir -p $(dirname "${{ matrix.feature.files[0] }}" 2>/dev/null || echo ".")
          
          cat > mock_implementation.md << EOF
          # Mock Implementation: ${{ matrix.feature.title }}
          
          This is a mock implementation created by the AI development workflow.
          
          ## Description
          ${{ matrix.feature.description }}
          
          ## Implementation Status
          - [x] Created placeholder files
          - [ ] Actual implementation (requires Claude Code API)
          - [ ] Unit tests
          - [ ] Integration tests
          
          ## Next Steps
          1. Configure Claude Code API integration
          2. Implement actual functionality
          3. Add comprehensive tests
          4. Update documentation
          
          Generated at: $(date)
          EOF
          
          git add .
          git commit -m "feat: add mock implementation for ${{ matrix.feature.title }}

          - Created placeholder for ${{ matrix.feature.description }}
          - Added implementation plan
          - Ready for Claude Code API integration
          
          ðŸ¤– Generated with AI Driven Development Workflow"
          
      - name: Create Pull Request
        run: |
          echo "ðŸ“¤ Pull Requestä½œæˆä¸­..."
          
          cat > pr_body.md << EOF
          ## ðŸš€ æ©Ÿèƒ½å®Ÿè£…: ${{ matrix.feature.title }}
          
          ### ðŸ“‹ æ¦‚è¦
          ${{ matrix.feature.description }}
          
          ### ðŸ”§ å®Ÿè£…å†…å®¹
          - Mockå®Ÿè£…ã®ä½œæˆ
          - åŸºæœ¬æ§‹é€ ã®æ•´å‚™
          - å®Ÿè£…è¨ˆç”»ã®ç­–å®š
          
          ### ðŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
          $(echo '${{ toJson(matrix.feature.files) }}' | jq -r '.[] | "- `" + . + "`"')
          
          ### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [x] Mockå®Ÿè£…ã®ä½œæˆ
          - [ ] å®Ÿéš›ã®æ©Ÿèƒ½å®Ÿè£…ï¼ˆClaude Code APIé€£æºå¾Œï¼‰
          - [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆè¿½åŠ 
          - [ ] çµ±åˆãƒ†ã‚¹ãƒˆè¿½åŠ 
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
          
          ### ðŸ”— é–¢é€£Issue
          Implements features planned in the AI-generated issues.
          
          ### ðŸ¤– AIç”Ÿæˆæƒ…å ±
          - **å„ªå…ˆåº¦**: ${{ matrix.feature.priority }}
          - **è¦‹ç©ã‚‚ã‚Š**: ${{ matrix.feature.estimate }}
          - **ç”Ÿæˆæ™‚åˆ»**: $(date)
          
          ---
          *ã“ã®PRã¯AIé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF
          
          git push origin "$BRANCH_NAME"
          
          PR_URL=$(gh pr create \
            --title "feat: ${{ matrix.feature.title }}" \
            --body-file pr_body.md \
            --label "ai-generated,feature,${{ matrix.feature.priority }}-priority" \
            --assignee "@me")
            
          echo "âœ… Pull Requestä½œæˆå®Œäº†: $PR_URL"
          
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  automated-review:
    runs-on: ubuntu-latest
    needs: [setup, parallel-implementation]
    if: needs.setup.outputs.should-review == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Get open pull requests
        id: get-prs
        run: |
          echo "ðŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®PRã‚’æ¤œç´¢ä¸­..."
          
          # AIç”Ÿæˆã•ã‚ŒãŸPRã‚’å–å¾—
          PRS=$(gh pr list --label "ai-generated" --json number,title,headRefName --limit 10)
          echo "Found PRs: $PRS"
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Automated review (Mock)
        run: |
          echo "ðŸ¤– è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œä¸­..."
          
          # Mock ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå®Ÿéš›ã®Claude Code APIå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆäºˆå®šï¼‰
          echo '${{ steps.get-prs.outputs.prs }}' | jq -r '.[] | .number' | while read PR_NUMBER; do
            echo "ðŸ“ PR #$PR_NUMBER ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­..."
            
            cat > review_comment.md << EOF
          ðŸ¤– **AIè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœ**
          
          ## ðŸ“Š ã‚³ãƒ¼ãƒ‰å“è³ªã‚¹ã‚³ã‚¢: 85/100
          
          ### âœ… è‰¯ã„ç‚¹
          - ã‚³ãƒ¼ãƒ‰æ§‹é€ ãŒæ•´ç†ã•ã‚Œã¦ã„ã‚‹
          - å‘½åè¦å‰‡ã«æº–æ‹ ã—ã¦ã„ã‚‹
          - é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
          
          ### âš ï¸ æ”¹å–„ææ¡ˆ
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¿½åŠ ã‚’æŽ¨å¥¨
          - [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š
          - [ ] TypeScriptåž‹å®šç¾©ã®æœ€é©åŒ–
          
          ### ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          - âœ… æ˜Žã‚‰ã‹ãªè„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œãš
          - âœ… æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ãƒªã‚¹ã‚¯ãªã—
          
          ### ðŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹
          - âœ… ç‰¹ã«å•é¡Œã¨ãªã‚‹å‡¦ç†ã¯è¦‹ã¤ã‹ã‚‰ãš
          
          ---
          *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯AIé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          *è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã¯Claude Code APIé€£æºãŒå¿…è¦ã§ã™*
          EOF
            
            gh pr comment "$PR_NUMBER" --body-file review_comment.md
            
            echo "âœ… PR #$PR_NUMBER ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†"
          done
          
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-and-notify:
    runs-on: ubuntu-latest
    needs: [setup, analyze-requirements, generate-issues, parallel-implementation, automated-review]
    if: always()
    steps:
      - name: Workflow summary
        run: |
          echo "ðŸ“Š AIé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ"
          echo "========================================="
          echo "ãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.mode }}"
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date)"
          echo ""
          
          if [ "${{ needs.analyze-requirements.result }}" = "success" ]; then
            echo "âœ… è¦ä»¶è§£æž: æˆåŠŸ (${{ needs.analyze-requirements.outputs.total-issues }}å€‹ã®æ©Ÿèƒ½ã‚’æ¤œå‡º)"
          else
            echo "âŒ è¦ä»¶è§£æž: å¤±æ•—ã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—"
          fi
          
          if [ "${{ needs.generate-issues.result }}" = "success" ]; then
            echo "âœ… Issueç”Ÿæˆ: æˆåŠŸ"
          else
            echo "âŒ Issueç”Ÿæˆ: å¤±æ•—ã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—"
          fi
          
          if [ "${{ needs.parallel-implementation.result }}" = "success" ]; then
            echo "âœ… ä¸¦è¡Œå®Ÿè£…: æˆåŠŸ"
          else
            echo "âŒ ä¸¦è¡Œå®Ÿè£…: å¤±æ•—ã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—"
          fi
          
          if [ "${{ needs.automated-review.result }}" = "success" ]; then
            echo "âœ… è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼: æˆåŠŸ"
          else
            echo "âŒ è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼: å¤±æ•—ã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—"
          fi
          
          echo ""
          echo "ðŸ”— è©³ç´°æƒ…å ±:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Workflow: ${{ github.workflow }}"
          echo "- Run ID: ${{ github.run_id }}"
          
      - name: Create completion issue
        run: |
          cat > completion_report.md << EOF
          ## ðŸ¤– AIé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ
          
          **å®Ÿè¡Œæ—¥æ™‚**: $(date)
          **ãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.mode }}
          **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### ðŸ“Š å®Ÿè¡Œçµæžœ
          
          | ã‚¹ãƒ†ãƒ¼ã‚¸ | çµæžœ | è©³ç´° |
          |---------|-----|------|
          | è¦ä»¶è§£æž | ${{ needs.analyze-requirements.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.analyze-requirements.outputs.total-issues || '0' }}å€‹ã®æ©Ÿèƒ½ã‚’æ¤œå‡º |
          | Issueç”Ÿæˆ | ${{ needs.generate-issues.result == 'success' && 'âœ…' || 'âŒ' }} | è‡ªå‹•Issueä½œæˆ |
          | ä¸¦è¡Œå®Ÿè£… | ${{ needs.parallel-implementation.result == 'success' && 'âœ…' || 'âŒ' }} | Mockå®Ÿè£…ä½œæˆ |
          | è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ | ${{ needs.automated-review.result == 'success' && 'âœ…' || 'âŒ' }} | PRè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ |
          
          ### ðŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. Claude Code APIé€£æºã®è¨­å®š
          2. å®Ÿéš›ã®æ©Ÿèƒ½å®Ÿè£…ã®å®Ÿè¡Œ
          3. ãƒ¬ãƒ“ãƒ¥ãƒ¼å“è³ªã®å‘ä¸Š
          4. ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–ã®æ‹¡å……
          
          ### ðŸ”§ æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ
          - [ ] Claude Code APIçµ±åˆ
          - [ ] ã‚ˆã‚Šè©³ç´°ãªè¦ä»¶è§£æž
          - [ ] é«˜åº¦ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯
          - [ ] è‡ªå‹•ä¿®æ­£æ©Ÿèƒ½
          
          ---
          *ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯AIé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF
          
          gh issue create \
            --title "ðŸ¤– AIé§†å‹•é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ ($(date +%Y-%m-%d))" \
            --body-file completion_report.md \
            --label "ai-generated,workflow-report" \
            --assignee "@me"
            
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}